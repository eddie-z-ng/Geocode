// Global object literal
var GEOCODE_DEMO = { };

/*var utilities = {
	printAllMembers: function(targetObject) {
		for (i in targetObject) {
			alert(i + " : " + targetObject[i]);
		}
	}
}*/

function clearOverlays() {
  for (var i = 0; i < GEOCODE_DEMO.markersArray.length; i++ ) {
    GEOCODE_DEMO.markersArray[i].setMap(null);
  }
  GEOCODE_DEMO.markersArray = [];
};

function initialize() {
	GEOCODE_DEMO.gCoder = new google.maps.Geocoder();
	GEOCODE_DEMO.infowindow = new google.maps.InfoWindow();
	GEOCODE_DEMO.markersArray = [];
	var latlng = new google.maps.LatLng(40.7143528,-74.0059731)
	var mapOptions = {
	  zoom: 6,
	  center: latlng,
	  mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	GEOCODE_DEMO.map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
	
	var marker1 = new google.maps.Marker({
		map: GEOCODE_DEMO.map,
		position: latlng
	});
	
	GEOCODE_DEMO.markersArray.push(marker1);
	
	GEOCODE_DEMO.gCoder.geocode( { 'latLng': latlng}, function(results, status) {
	  if (status == google.maps.GeocoderStatus.OK) {
		marker1.setTitle(results[0].formatted_address);
		/*GEOCODE_DEMO.infowindow.setContent(results[0].formatted_address + " " + \
											GEOCODE_DEMO.map.getCenter().lat() + "," + \
											GEOCODE_DEMO.map.getCenter().lng());
		google.maps.event.addListener(
			marker1,
			'click',
			function(){
				GEOCODE_DEMO.infowindow.open(GEOCODE_DEMO.map, marker1);
			});*/
	  } else {
			$('#alertMessage').text("Geocode was not successful for the following reason: " + status);
			$('#alertGroup').show();
	  }
	});
	
	GEOCODE_DEMO.sViewPano = new google.maps.StreetViewPanorama(document.getElementById("streetview-canvas"));
	GEOCODE_DEMO.sViewPano.setPov( {
		heading: 34,
		pitch: 10,
		zoom: 1
	});
	
	// Bind the Streetview Panorama to the this map so Streetview is displayed on its own canvas
	GEOCODE_DEMO.map.setStreetView(GEOCODE_DEMO.sViewPano); 
	
	GEOCODE_DEMO.sView = GEOCODE_DEMO.map.getStreetView();
	GEOCODE_DEMO.sView.setPosition(latlng);
};

function codeAddress() {
	clearOverlays();
	$('#alertGroup').hide();
	$("#divResult").fadeOut();
	var address = document.getElementById("address").value;
	if (address !== '') {
		GEOCODE_DEMO.gCoder.geocode( { 'address': address}, function(results, status) {
		  if (status === google.maps.GeocoderStatus.OK) {
			// Pan to the location smoothly if less than width and height of current map
			GEOCODE_DEMO.map.panTo(results[0].geometry.location);
			GEOCODE_DEMO.map.setCenter(results[0].geometry.location);
			GEOCODE_DEMO.map.setZoom(18);
			
			GEOCODE_DEMO.sView = GEOCODE_DEMO.map.getStreetView();
			GEOCODE_DEMO.sView.setPosition(results[0].geometry.location);

			var marker2 = new google.maps.Marker({
				map: GEOCODE_DEMO.map,
				position: results[0].geometry.location,
				title: results[0].formatted_address
			});
			GEOCODE_DEMO.markersArray.push(marker2);
			
			//GEOCODE_DEMO.infowindow.setContent(results[0].formatted_address);
			/*GEOCODE_DEMO.infowindow.setContent(results[0].formatted_address + " " + \
												GEOCODE_DEMO.map.getCenter().lat() + "," + \
												GEOCODE_DEMO.map.getCenter().lng());
			// + " : " GEOCODE_DEMO.map.getCenter().lat() + ", " + GEOCODE_DEMO.map.getCenter().lng()
			google.maps.event.addListener(
				marker2,
				'click',
				function(){
					GEOCODE_DEMO.infowindow.open(GEOCODE_DEMO.map, marker2);
			});*/
			
		  } else {
				$('#alertMessage').text("Geocode was not successful for the following reason: " + status);
				$('#alertGroup').show();
		  }
		});
	}
};

function formatResults(results) {
	var res = "";
	jQuery.each(results, function (i, val) {
		console.log(val.formatted_address);
		res += "<div class=\"display_box\" align=\"left\">";
		res += "<span class=\"location\">";
		res += val.formatted_address;
		res += "</span>";
		res += "<br/>";
		res += "</div>";
	});

	return res;
};

$(function () {

	initialize();
	//utilities.printAllMembers(GEOCODE_DEMO);
	
	$('#address').attr("autocomplete","off");
	
	$('#searchButton').click(codeAddress);
	$('#address').keypress(function(e){
        if(e.which == 13){	//Enter key pressed
            codeAddress();	//Trigger search button click event
        }
		
		/*var $hlight = $('#divResult'), $div = $('div');
		if (e.keyCode == 40) {
			$hlight.removeClass('hlight').next().addClass('hlight');
			if ($hlight.next().length == 0) {
				$div.eq(0).addClass('hlight')
			}
		} else if (e.keyCode === 38) {
			$hlight.removeClass('hlight').prev().addClass('hlight');
			if ($hlight.prev().length == 0) {
				$div.eq(-1).addClass('hlight')
			}
		}*/
    });
	
	$('#address').keyup(function () {
		var inputSearch = $(this).val();
		var d = document.getElementById("divResult");
		if (inputSearch != '') {
			GEOCODE_DEMO.gCoder.geocode( 
			{
				address: inputSearch,
				region: 'no'
			}, function (results, status) {
				if (status === google.maps.GeocoderStatus.OK) {
					//d.html(formatResults(results)).show();
					$("#divResult").html(formatResults(results)).show();
				}
			});
		} return false;
	});
	
	$('#divResult').on("click", function (e) {
		var $clicked = $(e.target);
		var $location = $clicked.text(); //$clicked.find('.location').html();
		        console.log("#divResult click: clicked:")
                console.log($clicked);
                console.log("#divResult click: location: ");
                console.log($location);
		if ($location !== undefined && $location !== null) {
			//var decoded = $("<div/>").html($location).text();
			//$('#address').val(decoded);
			$('#address').val($location);
			codeAddress();
		}
	});
	
	$('#address').focusout(function () {
		$('#divResult').fadeOut();
	});

	//$('#map-canvas form').action(codeAddress);
	
	$('#firstpara').hide();
	$('#alertGroup').hide();
	
	$('#searchButton').click(function () {
		$('#firstpara').show('fast').fadeOut(2000);
	});
	
	$('.bigButton').button();
	
	// Hover states on the static widgets
	/*$('span').hover(
		function() {
			$( this ).addClass( "ui-state-hover" );
		},
		function() {
			$( this ).removeClass( "ui-state-hover" );
		}
	);*/
	
	// Hover states on the static widgets
	/*$( "#icons button" ).hover(
		function() {
			$( this ).addClass( "ui-state-hover" );
		},
		function() {
			$( this ).removeClass( "ui-state-hover" );
		}
	);*/
});